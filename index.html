<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT Virtual ‚Äì Modo PRO (Vision + T√°tica + Chat)</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0b1220;color:#f3f6ff}
    .wrap{display:grid;grid-template-columns: 720px 1fr; gap:16px; padding:16px}
    #background-square{position:relative;width:600px;height:300px;background:#1b5e20;border:2px solid #fff;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    /* HUD */
    #tactical-hud{display:none;background:#0e1a33;border:1px solid #1f3b6b;border-radius:12px;padding:12px}
    #tactical-hud h3{margin:0 0 8px 0;font-size:14px;opacity:.9}
    #hud-formations,#hud-phase,#hud-block{font-size:13px;margin:2px 0}
    /* Bot√µes */
    .bar{display:flex;gap:8px;margin:8px 0}
    button{background:#0f5bd8;border:0;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    /* C√≠rculos */
    .circle{position:absolute;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,.4)}
    .green{background:#12b886}
    .black{background:#111}
    #ball{position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.5)}
    /* Chat */
    #chat{display:flex;flex-direction:column;height:300px;background:#0e1328;border:1px solid #1e2c55;border-radius:12px}
    #chat-log{flex:1;overflow:auto;padding:12px;line-height:1.4}
    .msg{margin:6px 0;font-size:13px}
    .msg.me{color:#c4d4ff}
    .msg.coach{color:#86f6c9}
    .msg.sys{color:#9aa4b2;font-style:italic}
    #chat-form{display:flex;border-top:1px solid #1e2c55}
    #chat-input{flex:1;background:transparent;border:0;color:#fff;padding:10px}
    #chat-send{border-left:1px solid #1e2c55}
    /* Notifica√ß√£o */
    #ai-notification{display:none;position:fixed;left:16px;bottom:16px;background:#0e1a33;border:1px solid #1f3b6b;border-radius:10px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="bar">
        <button id="ai-analise-btn">An√°lise IA</button>
        <button id="reset-btn" title="Recentrar jogadores">Reset</button>
      </div>
      <div id="background-square">
        <!-- C√çRCULOS ADVERS√ÅRIO 1..11 -->
        <div id="circle1" class="circle black" style="left:40px;top:140px">1</div>
        <div id="circle2" class="circle black" style="left:80px;top:60px">2</div>
        <div id="circle3" class="circle black" style="left:80px;top:220px">3</div>
        <div id="circle4" class="circle black" style="left:120px;top:100px">4</div>
        <div id="circle5" class="circle black" style="left:120px;top:180px">5</div>
        <div id="circle6" class="circle black" style="left:170px;top:70px">6</div>
        <div id="circle7" class="circle black" style="left:170px;top:230px">7</div>
        <div id="circle8" class="circle black" style="left:210px;top:110px">8</div>
        <div id="circle9" class="circle black" style="left:210px;top:190px">9</div>
        <div id="circle10" class="circle black" style="left:260px;top:140px">10</div>
        <div id="circle11" class="circle black" style="left:300px;top:140px">11</div>
        <!-- C√çRCULOS PALMEIRAS 13..23 (12 reservado) -->
        <div id="circle13" class="circle green" style="left:520px;top:60px">13</div>
        <div id="circle14" class="circle green" style="left:520px;top:220px">14</div>
        <div id="circle15" class="circle green" style="left:490px;top:110px">15</div>
        <div id="circle16" class="circle green" style="left:490px;top:170px">16</div>
        <div id="circle17" class="circle green" style="left:420px;top:80px">17</div>
        <div id="circle18" class="circle green" style="left:420px;top:130px">18</div>
        <div id="circle19" class="circle green" style="left:420px;top:170px">19</div>
        <div id="circle20" class="circle green" style="left:420px;top:220px">20</div>
        <div id="circle21" class="circle green" style="left:330px;top:120px">21</div>
        <div id="circle22" class="circle green" style="left:330px;top:180px">22</div>
        <div id="circle23" class="circle green" style="left:585px;top:150px">23</div>
        <!-- BOLA -->
        <div id="circle24" style="left:300px;top:150px" ></div>
      </div>
      <div id="tactical-hud">
        <h3>HUD T√°tico</h3>
        <div id="hud-formations">Advers√°rio: ? | Palmeiras: ?</div>
        <div id="hud-phase">Fase: ?</div>
        <div id="hud-block">Bloco: ? | Compacta√ß√£o: ?</div>
      </div>
    </div>

    <div>
      <div id="chat">
        <div id="chat-log"></div>
        <form id="chat-form" autocomplete="off">
          <input id="chat-input" placeholder="Fale com o Abel‚Ä¶" />
          <button id="chat-send" type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>

  <div id="ai-notification"></div>

<script>
// ======================
// ESTADO GLOBAL MODO PRO
// ======================
const tacticalState = {
  possession: "preto",
  opponentFormation: null,
  palFormation: "4-3-3",
  phase: "defesa",
  block: "baixo",
  compactacao: "curta",
  green: []
};

// ======================
// SOCKET (Chat & eventos)
// ======================
const socket = io(window.location.origin, {transports:["websocket","polling"]});
window.socket = socket;

socket.on("connect", ()=> logMsg(`üîå Conectado (${socket.id})`, "sys"));
socket.on("chat-message", (m)=> logMsg(`üë§ ${m}`, "me"));
socket.on("coach-message", (m)=> logMsg(`üéôÔ∏è Abel: ${m}`, "coach"));

function logMsg(txt, cls="sys"){ const box=document.getElementById("chat-log"); const d=document.createElement("div"); d.className=`msg ${cls}`; d.textContent=txt; box.appendChild(d); box.scrollTop=box.scrollHeight; }

// Envio do chat
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");
chatForm.addEventListener("submit", (e)=>{ e.preventDefault(); const t=chatInput.value.trim(); if(!t) return; socket.emit("chat-message", t); logMsg(`Voc√™: ${t}`, "me"); chatInput.value="";});

// ======================
// Fun√ß√µes auxiliares essenciais
// ======================
function $(id){ return document.getElementById(id); }

function animateTeam(prefix, positions, done){
  positions.forEach(p=>{
    const el = $(prefix+p.id);
    if(!el) return;
    el.style.transition = "left .45s cubic-bezier(.25,.8,.25,1), top .45s cubic-bezier(.25,.8,.25,1)";
    el.style.left = p.left+"px";
    el.style.top  = p.top+"px";
  });
  if(typeof done==="function") setTimeout(done, 460);
}

function applyDynamicBlocks(greenPositions, phase="defesa", opponentFormation="?"){
  // Placeholder ‚Äì mant√©m compatibilidade visual
  const hudPhase = $("hud-phase");
  const hudBlock = $("hud-block");
  if(hudPhase) hudPhase.innerText = `Fase: ${phase}`;
  if(hudBlock) hudBlock.innerText = `Bloco: ${tacticalState.block} | Compacta√ß√£o: ${tacticalState.compactacao}`;
}

// === Campo/bola/jogadores helpers ===
function getOpponentPositions(){ const arr=[]; for(let i=1;i<=11;i++){ const el=$("circle"+i); if(el){ arr.push({id:i,left:parseInt(el.style.left||el.offsetLeft),top:parseInt(el.style.top||el.offsetTop)});} } return arr; }
function getPalmeirasPositions(){ const arr=[]; for(let i=13;i<=23;i++){ const el=$("circle"+i); if(el){ arr.push({id:i,left:parseInt(el.style.left||el.offsetLeft),top:parseInt(el.style.top||el.offsetTop)});} } return arr; }
function getBall(){ const el=$("circle24"); return {left:parseInt(el.style.left||el.offsetLeft), top:parseInt(el.style.top||el.offsetTop)}; }

function makeVisionSnapshot(){
  const cw=600,ch=300; const off=document.createElement("canvas"); off.width=cw; off.height=ch; const g=off.getContext("2d");
  g.fillStyle="#2e7d32"; g.fillRect(0,0,cw,ch);
  g.strokeStyle="#ffffff"; g.lineWidth=2; g.strokeRect(1,1,cw-2,ch-2); g.beginPath(); g.moveTo(cw/2,0); g.lineTo(cw/2,ch); g.stroke(); g.beginPath(); g.arc(cw/2,ch/2,46,0,Math.PI*2); g.stroke();
  g.strokeRect(0,75,60,150); g.strokeRect(cw-60,75,60,150); g.strokeRect(0,100,20,100); g.strokeRect(cw-20,100,20,100);
  const green=getPalmeirasPositions(), black=getOpponentPositions(), ball=getBall();
  g.fillStyle="#111"; black.forEach(p=>{g.beginPath(); g.arc(p.left-20,p.top-20,13,0,Math.PI*2); g.fill();});
  g.fillStyle="#12b886"; green.forEach(p=>{g.beginPath(); g.arc(p.left-20,p.top-20,13,0,Math.PI*2); g.fill();});
  g.fillStyle="#fff"; g.beginPath(); g.arc(ball.left-20,ball.top-20,6,0,Math.PI*2); g.fill();
  return off.toDataURL("image/png");
}

function detectBallPossession(green, black, ball){
  const field=$("background-square").getBoundingClientRect();
  const bx=(ball.left-field.left), cx=field.width/2;
  const dG=Math.min(...green.map(p=>Math.hypot(p.left-ball.left,p.top-ball.top)));
  const dB=Math.min(...black.map(p=>Math.hypot(p.left-ball.left,p.top-ball.top)));
  const sideBias = bx < cx ? -8 : +8; // favorece verde se bola est√° √† esquerda
  return (dG+sideBias) < dB ? "verde" : "preto";
}
function getCurrentPossession(){ return detectBallPossession(getPalmeirasPositions(), getOpponentPositions(), getBall()); }

// ======================
// MODO PRO: Render do estado
// ======================
function renderTacticState(){
  if(!tacticalState.green || !tacticalState.green.length) return;
  animateTeam("circle", tacticalState.green, ()=>{
    applyDynamicBlocks(
      tacticalState.green,
      (tacticalState.phase||"defesa").toLowerCase(),
      tacticalState.opponentFormation||"?"
    );
  });
  $("tactical-hud").style.display = "block";
  $("hud-formations").innerText = `Advers√°rio: ${tacticalState.opponentFormation} | Palmeiras: ${tacticalState.palFormation}`;
  $("hud-phase").innerText = `Fase: ${tacticalState.phase}`;
  $("hud-block").innerText = `Bloco: ${tacticalState.block} | Compacta√ß√£o: ${tacticalState.compactacao}`;
}

// ======================
// Bot√£o Manual (opcional)
// ======================
const aiBtn = $("ai-analise-btn");
aiBtn.addEventListener("click", updateTacticalState);
$("reset-btn").addEventListener("click", ()=>{ location.reload(); });

// ======================
// UPDATE T√ÅTICO (1 request)
// ======================
async function updateTacticalState(){
  try{
    aiBtn.disabled=true; aiBtn.textContent="‚åõ IA Calculando...";
    const payload={ fieldImage:makeVisionSnapshot(), green:getPalmeirasPositions(), black:getOpponentPositions(), ball:getBall(), possession:getCurrentPossession() };
    const res = await fetch("/ai/tactical-auto",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
    const data = await res.json();

    tacticalState.possession        = data.possession;
    tacticalState.opponentFormation = data.opponentFormation;
    tacticalState.palFormation      = data.detectedFormation;
    tacticalState.phase             = data.phase;
    tacticalState.block             = data.bloco;
    tacticalState.compactacao       = data.compactacao;
    tacticalState.green             = data.green;

    renderTacticState();
    if(data.coachComment) logMsg(`Abel: ${data.coachComment}`, "coach");
  }catch(e){
    console.error(e); logMsg("‚ùå Erro na IA t√°tica","sys");
  }finally{
    aiBtn.disabled=false; aiBtn.textContent="An√°lise IA";
  }
}

// ======================
// IA AUTOM√ÅTICA (Lightning Mode)
// ======================
let lastPossession=null; let autoRunning=false;
async function autoAnalyzeLoop(){
  if(autoRunning) return; autoRunning=true;
  try{
    const payload={ fieldImage:makeVisionSnapshot(), green:getPalmeirasPositions(), black:getOpponentPositions(), ball:getBall(), possession:getCurrentPossession() };
    const res = await fetch("/ai/tactical-auto",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
    const data = await res.json();
    const changed = data.possession!==lastPossession || data.detectedFormation!==tacticalState.palFormation;
    if(changed){
      tacticalState.possession        = data.possession;
      tacticalState.opponentFormation = data.opponentFormation;
      tacticalState.palFormation      = data.detectedFormation;
      tacticalState.phase             = data.phase;
      tacticalState.block             = data.bloco;
      tacticalState.compactacao       = data.compactacao;
      tacticalState.green             = data.green;
      renderTacticState();
      if(data.coachComment) logMsg(`Abel: ${data.coachComment}`, "coach");
    }
    lastPossession=data.possession;
  }catch(e){ console.error(e); }
  finally{ autoRunning=false; }
}
setInterval(autoAnalyzeLoop, 650);
</script>
</body>
</html>

